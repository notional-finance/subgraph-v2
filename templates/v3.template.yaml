specVersion: 0.0.8
description: Notional V3 Subgraph
repository: https://github.com/notional-finance/contracts-v2
schema:
  file: ./schema.graphql
dataSources:
  - name: Assets
    kind: ethereum/contract
    network: {{ networkName }}
    source:
      address: '{{ notional }}'
      abi: NotionalV3
      startBlock: {{ startBlock }}
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      file: ./src/assets.ts
      entities:
        - Asset
      abis:
        - name: NotionalV2
          file: ./abi/NotionalV2.json
        - name: NotionalV3
          file: ./abi/NotionalV3.json
        - name: ERC20
          file: ./abi/ERC20.json
      eventHandlers:
        - event: ListCurrency(uint16)
          handler: handleListCurrency
        - event: PrimeProxyDeployed(indexed uint16,address,bool)
          handler: handleDeployPrimeProxy
        - event: DeployNToken(uint16,address)
          handler: handleDeployNToken
        - event: Upgraded(indexed address)
          handler: handleUpgrade
  - name: Transactions
    kind: ethereum/contract
    network: {{ networkName }}
    source:
      address: '{{ notional }}'
      abi: NotionalV3
      startBlock: {{ startBlock }}
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      file: ./src/transactions.ts
      entities:
        - Transfer
        - Asset
        - Balance
        - Account
        - Market
        - MarketSnapshot
        - Incentives
      abis:
        - name: NotionalV2
          file: ./abi/NotionalV2.json
        - name: NotionalV3
          file: ./abi/NotionalV3.json
        - name: IStrategyVault
          file: ./abi/IStrategyVault.json
        - name: ERC4626
          file: ./abi/ERC4626.json
        - name: AssetRateAggregator
          file: ./abi/AssetRateAggregator.json
      eventHandlers:
        - event: TransferSingle(indexed address,indexed address,indexed address,uint256,uint256)
          handler: handleERC1155Transfer
        - event: TransferBatch(indexed address,indexed address,indexed address,uint256[],uint256[])
          handler: handleERC1155BatchTransfer
  - name: ExchangeRates
    kind: ethereum/contract
    network: {{ networkName }}
    source:
      address: '{{ notional }}'
      abi: NotionalV3
      startBlock: {{ startBlock }}
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      file: ./src/exchange_rates.ts
      entities:
        - Asset
        - Oracle
        - OracleRegistry
        - ExchangeRate
      abis:
        - name: NotionalV2
          file: ./abi/NotionalV2.json
        - name: NotionalV3
          file: ./abi/NotionalV3.json
        - name: Aggregator
          file: ./abi/Aggregator.json
        - name: AssetRateAggregator
          file: ./abi/AssetRateAggregator.json
        - name: IStrategyVault
          file: ./abi/IStrategyVault.json
        - name: ERC4626
          file: ./abi/ERC4626.json
      eventHandlers:
        - event: UpdateETHRate(uint16)
          handler: handleUpdateETHRate
        - event: VaultUpdated(indexed address,bool,uint80)
          handler: handleVaultListing
        - event: DeployNToken(uint16,address)
          handler: handlefCashEnabled
        - event: PrimeCashInterestAccrued(indexed uint16,uint256,uint256,uint256)
          handler: handlePrimeCashAccrued
        - event: SetPrimeSettlementRate(indexed uint256,indexed uint256,int256,int256)
          handler: handleSettlementRate
        - event: CurrencyRebalanced(uint16,uint256,uint256)
          handler: handleRebalance
      blockHandlers:
        - handler: handleBlockOracleUpdate
          filter:
            kind: polling
            # Currently set to approx 6 hours between blocks, although this is not precise
            every: {{ pollingInterval }}
  - name: Configuration
    kind: ethereum/contract
    network: {{ networkName }}
    source:
      address: '{{ notional }}'
      abi: NotionalV3
      startBlock: {{ startBlock }}
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      file: ./src/configuration.ts
      entities:
        - CurrencyConfiguration
        - VaultConfiguration
        - WhitelistedContract
        - InterestRateCurve
        - ActiveMarkets
      abis:
        - name: NotionalV2
          file: ./abi/NotionalV2.json
        - name: NotionalV3
          file: ./abi/NotionalV3.json
        - name: PrimeCashHoldingsOracle
          file: ./abi/PrimeCashHoldingsOracle.json
        - name: IStrategyVault
          file: ./abi/IStrategyVault.json
        - name: ERC4626
          file: ./abi/ERC4626.json
        - name: AssetRateAggregator
          file: ./abi/AssetRateAggregator.json
      eventHandlers:
        - event: ListCurrency(uint16)
          handler: handleListCurrency
        - event: UpdateETHRate(uint16)
          handler: handleUpdateETHRate
        # Prime Cash Parameters
        - event: PrimeCashCurveChanged(indexed uint16)
          handler: handleUpdatePrimeCashCurve
        - event: PrimeCashHoldingsOracleUpdated(indexed uint16,address)
          handler: handleUpdatePrimeCashOracle
        - event: UpdateMaxUnderlyingSupply(indexed uint16,uint256)
          handler: handleUpdateMaxUnderlyingSupply
          # Check for prime debt enablement
        - event: PrimeProxyDeployed(indexed uint16,address,bool)
          handler: handleDeployPrimeProxy
        # fCash and nToken Parameters
        - event: UpdateCashGroup(uint16)
          handler: handleUpdateCashGroup
        - event: UpdateDepositParameters(uint16)
          handler: handleUpdateDepositParameters
        - event: UpdateInitializationParameters(uint16)
          handler: handleUpdateInitializationParameters
        - event: UpdateTokenCollateralParameters(uint16)
          handler: handleUpdateTokenCollateralParameters
        - event: UpdateInterestRateCurve(indexed uint16,indexed uint8)
          handler: handleUpdateInterestRateCurve
        - event: MarketsInitialized(uint16)
          handler: handleMarketsInitialized
        # Treasury Actions
        - event: IncentivesMigrated(uint16,uint256,uint256,uint256)
          handler: handleIncentivesMigrated
        - event: UpdateIncentiveEmissionRate(uint16,uint32)
          handler: handleUpdateIncentiveEmissionRate
        - event: ReserveBufferUpdated(uint16,uint256)
          handler: handleReserveBufferUpdate
        - event: RebalancingTargetsUpdated(uint16,(address,uint8)[])
          handler: handleRebalancingTargetsUpdated
        - event: RebalancingCooldownUpdated(uint16,uint40)
          handler: handleRebalancingCooldownUpdated
        # Whitelisted Contract
        - event: UpdateGlobalTransferOperator(address,bool)
          handler: handleUpdateGlobalTransferOperator
        - event: UpdateAuthorizedCallbackContract(address,bool)
          handler: handleUpdateAuthorizedCallbackContract
        - event: UpdateSecondaryIncentiveRewarder(indexed uint16,address)
          handler: handleUpdateSecondaryIncentiveRewarder
        # Vaults
        - event: VaultUpdated(indexed address,bool,uint80)
          handler: handleVaultUpdated
        - event: VaultPauseStatus(indexed address,bool)
          handler: handleVaultPauseStatus
        - event: VaultDeleverageStatus(indexed address,bool)
          handler: handleVaultDeleverageStatus
        - event: VaultUpdateSecondaryBorrowCapacity(indexed address,indexed uint16,uint80)
          handler: handleVaultUpdateSecondaryBorrowCapacity
        - event: VaultBorrowCapacityChange(indexed address,indexed uint16,uint256)
          handler: handleVaultBorrowCapacityChange
        # Account Context
        - event: AccountContextUpdate(indexed address)
          handler: handleAccountContextUpdate
          receipt: true
  - name: TradingModule
    kind: ethereum/contract
    network: {{ networkName }}
    source:
      address: '{{ tradingModule }}'
      abi: TradingModule
      startBlock: {{ startBlock }}
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      file: ./src/trading_module.ts
      entities:
        - Oracle
      abis:
        - name: Aggregator
          file: ./abi/Aggregator.json
        - name: TradingModule
          file: ./abi/TradingModule.json
        - name: NotionalV2
          file: ./abi/NotionalV2.json
        - name: NotionalV3
          file: ./abi/NotionalV3.json
        - name: ERC20
          file: ./abi/ERC20.json
      eventHandlers:
        - event: PriceOracleUpdated(address,address)
          handler: handlePriceOracleUpdate
        - event: TokenPermissionsUpdated(address,address,(bool,uint32,uint32))
          handler: handleTokenPermissionsUpdate
  - name: TreasuryManager
    kind: ethereum/contract
    network: {{ networkName }}
    source:
      address: '{{ treasuryManager }}'
      abi: TreasuryManager
      startBlock: {{ startBlock }}
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      file: ./src/treasury_manager.ts
      entities:
        - Reinvestment
      abis:
        - name: TreasuryManager
          file: ./abi/TreasuryManager.json
        - name: ISingleSidedLPStrategyVault
          file: ./abi/ISingleSidedLPStrategyVault.json
      eventHandlers:
        - event: VaultRewardReinvested(indexed address,indexed address,uint256,uint256)
          handler: handleVaultRewardReinvested
  # TODO: add snote balancer pool and snote
  - name: NotionalV2Events
    kind: ethereum/contract
    network: {{ networkName }}
    source:
      address: '{{ notional }}'
      abi: NotionalV2
      startBlock: {{ startBlock }}
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      file: ./src/v2/handle_v2.ts
      entities:
        - Transfer
      abis:
        - name: NotionalV2
          file: ./abi/NotionalV2.json
        - name: NotionalV3
          file: ./abi/NotionalV3.json
        - name: ERC4626
          file: ./abi/ERC4626.json
        - name: ERC20
          file: ./abi/ERC20.json
        - name: AssetRateAggregator
          file: ./abi/AssetRateAggregator.json
      eventHandlers:
        - event: ReserveBalanceUpdated(indexed uint16,int256)
          handler: handleReserveBalanceUpdated
        - event: IncentivesMigrated(uint16,uint256,uint256,uint256)
          handler: handleIncentivesMigrated
        - event: SetSettlementRate(indexed uint256,indexed uint256,uint128)
          handler: handleV2SettlementRate
        - event: MigratedToV3()
          handler: handleMigrateToV3
        - event: EndV3AccountEvents()
          handler: handleEndMigrateToV3
        # - event: ReserveFeeAccrued(indexed uint16,int256)
        #   handler: handleReserveFeeAccrued
        # - event: AccountSettled(indexed address)
        #   handler: handleAccountSettled
        # - event: LendBorrowTrade(indexed address,indexed uint16,uint40,int256,int256)
        #   handler: handleLendBorrowTrade
        # - event: SettledCashDebt(indexed address,indexed uint16,indexed address,int256,int256)
        #   handler: handleSettledCashDebt
        # - event: nTokenSupplyChange(indexed address,indexed uint16,int256)
        #   handler: handleNTokenSupplyChange
        # - event: nTokenResidualPurchase(indexed uint16,indexed uint40,indexed address,int256,int256)
        #   handler: handleNTokenResidualPurchase
        # - event: LiquidateLocalCurrency(indexed address,indexed address,uint16,int256)
        #   handler: handleLiquidateLocalCurrency
        # - event: LiquidateCollateralCurrency(indexed address,indexed address,uint16,uint16,int256,int256,int256)
        #   handler: handleLiquidateCollateralCurrency
        # - event: LiquidatefCashEvent(indexed address,indexed address,uint16,uint16,int256,uint256[],int256[])
        #   handler: handleLiquidatefCashEvent
        # - event: CashBalanceChange(indexed address,indexed uint16,int256)
        #   handler: handleCashBalanceChange
templates:
  - name: ERC20Proxy
    kind: ethereum/contract
    network: {{ networkName }}
    source:
      abi: ERC4626
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      file: ./src/transactions.ts
      entities:
        - Transfer
        - Asset
        - Underlying
        - Balance
        - Account
      abis:
        - name: NotionalV2
          file: ./abi/NotionalV2.json
        - name: NotionalV3
          file: ./abi/NotionalV3.json
        - name: ERC20
          file: ./abi/ERC20.json
        - name: ERC4626
          file: ./abi/ERC4626.json
      eventHandlers:
        - event: Transfer(indexed address,indexed address,uint256)
          handler: handleERC20Transfer
        - event: ProxyRenamed()
          handler: handleProxyRenamed